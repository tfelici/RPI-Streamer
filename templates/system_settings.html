<!DOCTYPE html>
<html lang="en">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - RPI Streamer</title>
</head>
<body>
    {% include 'navbar.html' %}
    
    <div class="container">
        <div class="frame">
            <h1>System Settings</h1>
            
            <!-- Authentication Settings -->            <form id="auth-form">
                <h2>Basic Authentication</h2>
                <label for="auth-username">Username</label>
                <input type="text" id="auth-username" name="username" required>
                
                <label for="auth-password">Password</label>
                <p class="help-text" style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-secondary);">
                    Leave password blank to disable authentication completely.
                </p>
                <div style="position: relative;">
                    <input type="password" id="auth-password" name="password">
                    <label style="display: inline-flex; align-items: center; margin-top: 0.5rem; font-size: 0.9rem;">
                        <input type="checkbox" id="toggle-auth-pass" style="margin-right: 0.5rem;"> Show Password
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">Save Auth Settings</button>
                <div id="auth-result" class="status-message" style="display: none;"></div>
            </form>
        </div>
        
        <div class="frame">
            <!-- WiFi Management -->
            <h2>WiFi Management</h2>
            
            <!-- WiFi Mode Selection -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">WiFi Mode</label>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center;">
                        <input type="radio" name="wifi-mode" value="client" id="mode-client" style="margin-right: 0.5rem;">
                        Client Mode (Connect to existing WiFi)
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="radio" name="wifi-mode" value="hotspot" id="mode-hotspot" style="margin-right: 0.5rem;">
                        Hotspot Mode (Create WiFi network)
                    </label>
                </div>
                <div id="wifi-status" class="status-message" style="margin-bottom: 1rem;"></div>
            </div>
            
            <!-- Client Mode Settings -->
            <div id="client-settings" style="display: none;">
                <h3>Available WiFi Networks</h3>
                
                <!-- Scan Controls -->
                <div style="margin-bottom: 1rem; text-align: center;">
                    <button id="scan-wifi-btn" class="btn btn-secondary">Scan for Networks</button>
                    <div id="scan-status" style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;"></div>
                </div>
                
                <!-- Networks List -->
                <div id="wifi-networks" style="margin-bottom: 1.5rem;">
                    <div style="color: #666; text-align: center; padding: 1rem;">
                        Click "Scan for Networks" to see available WiFi networks
                    </div>
                </div>
                
                <!-- Manual Network Entry -->
                <details style="margin-top: 1.5rem;">
                    <summary style="cursor: pointer; font-weight: bold; margin-bottom: 1rem;">Manual Network Entry</summary>
                    <form id="wifi-form">
                        <label for="wifi-ssid">SSID</label>
                        <input type="text" id="wifi-ssid" name="ssid" required>
                        
                        <label for="wifi-pass">Password</label>
                        <div style="position: relative;">
                            <input type="password" id="wifi-pass" name="wifi_password" required>
                            <label style="display: inline-flex; align-items: center; margin-top: 0.5rem; font-size: 0.9rem;">
                                <input type="checkbox" id="toggle-wifi-pass" style="margin-right: 0.5rem;"> Show Password
                            </label>
                        </div>
                        
                        <button type="submit" id="wifi-connect-btn" class="btn btn-primary">Connect to Network</button>
                        <div id="wifi-result" class="status-message" style="display: none;"></div>
                    </form>
                </details>
            </div>
            
            <!-- Hotspot Mode Settings -->
            <div id="hotspot-settings" style="display: none;">
                <form id="hotspot-form">
                    <h3>Hotspot Settings</h3>
                    
                    <!-- QR Code Display -->
                    <div id="hotspot-qr-section" style="text-align: center; margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #dee2e6;">
                        <div style="margin-bottom: 0.5rem; font-weight: bold; color: #495057;">Current Hotspot - Scan to Connect</div>
                        <div id="hotspot-qr-code" style="margin-bottom: 0.5rem;"></div>
                        <div id="hotspot-qr-info" style="font-size: 0.9rem; color: #6c757d;"></div>
                    </div>
                    
                    <label for="hotspot-ssid">Hotspot Name (SSID)</label>
                    <input type="text" id="hotspot-ssid" name="hotspot_ssid" required>
                    
                    <label for="hotspot-pass">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="hotspot-pass" name="hotspot_password" value="rpistreamer123" required minlength="8">
                        <label style="display: inline-flex; align-items: center; margin-top: 0.5rem; font-size: 0.9rem;">
                            <input type="checkbox" id="toggle-hotspot-pass" style="margin-right: 0.5rem;"> Show Password
                        </label>
                    </div>
                    <p class="help-text" style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-secondary);">
                        Password must be at least 8 characters long.
                    </p>
                    
                    <div style="display: flex; gap: 1rem;">
                        <div style="flex: 1;">
                            <label for="hotspot-channel">WiFi Channel</label>
                            <select id="hotspot-channel" name="hotspot_channel">
                                <option value="1">1</option>
                                <option value="6" selected>6</option>
                                <option value="11">11</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label for="hotspot-ip">IP Address</label>
                            <input type="text" id="hotspot-ip" name="hotspot_ip" value="192.168.4.1" required>
                        </div>
                    </div>
                    
                    <button type="submit" id="hotspot-submit-btn" class="btn btn-primary">Save Hotspot Settings</button>
                    <div id="hotspot-result" class="status-message" style="display: none;"></div>
                </form>
            </div>
        </div>
        
        <div class="frame">
            <!-- Cellular Settings -->
            <h2>Cellular Settings</h2>
            
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #dee2e6;">
                <h3 style="margin-top: 0; margin-bottom: 1rem;">APN Configuration</h3>
                <form id="cellular-settings-form">
                    <div style="margin-bottom: 1rem;">
                        <label for="cellular-apn" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Access Point Name (APN)</label>
                        <input type="text" id="cellular-apn" name="cellular_apn" required style="width: 100%; max-width: 300px;">
                        <p class="help-text" style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">
                            Set the APN for your cellular carrier (e.g., "internet", "wap.vodafone.co.uk"). Contact your carrier if unsure.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="cellular-username" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Username</label>
                        <input type="text" id="cellular-username" name="cellular_username" style="width: 100%; max-width: 300px;">
                        <p class="help-text" style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">
                            Cellular username (often "wap" for Vodafone, or leave empty if not required).
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="cellular-password" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Password</label>
                        <input type="password" id="cellular-password" name="cellular_password" style="width: 100%; max-width: 300px;">
                        <p class="help-text" style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">
                            Cellular password (often "wap" for Vodafone, or leave empty if not required).
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="cellular-mcc" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">MCC (Mobile Country Code)</label>
                        <input type="text" id="cellular-mcc" name="cellular_mcc" style="width: 100%; max-width: 300px;" placeholder="234">
                        <p class="help-text" style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">
                            3-digit mobile country code (e.g., "234" for UK). Leave empty for auto-detection.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label for="cellular-mnc" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">MNC (Mobile Network Code)</label>
                        <input type="text" id="cellular-mnc" name="cellular_mnc" style="width: 100%; max-width: 300px;" placeholder="15">
                        <p class="help-text" style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">
                            2-3 digit mobile network code (e.g., "15" for Vodafone UK). Leave empty for auto-detection.
                        </p>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Cellular Settings</button>
                    <div id="cellular-result" class="status-message" style="display: none;"></div>
                </form>
            </div>
        </div>
        
        <div class="frame">
            <!-- System Controls -->
            <h2>System Controls</h2>
            
            <!-- Power Management Settings -->
            <div style="margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #dee2e6;">
                <h3 style="margin-top: 0; margin-bottom: 1rem;">Power Management</h3>
                <form id="power-settings-form">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <label for="power-sleep-time" style="margin: 0; font-weight: bold;">Grace Period (seconds):</label>
                        <input type="number" id="power-sleep-time" name="power_monitor_sleep_time" min="0" max="3600" step="1" required style="width: 100px;">
                        <button type="submit" class="btn btn-primary" style="padding: 0.25rem 0.75rem;">Save</button>
                    </div>
                    <p class="help-text" style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: var(--text-secondary);">
                        Time to wait before shutting down when power is lost and tracking is inactive (0 = disable power monitoring)
                    </p>
                    <div id="power-settings-result" class="status-message" style="display: none;"></div>
                </form>
            </div>
            
            <!-- System Operations -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                <!-- Power Controls -->
                <div style="text-align: center;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #495057;">Power Controls</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button id="reboot-btn" class="btn btn-danger" style="padding: 0.5rem;">Reboot System</button>
                        <button id="shutdown-btn" class="btn btn-danger" style="padding: 0.5rem;">Shutdown System</button>
                    </div>
                    <div id="reboot-result" class="status-message" style="display: none; margin-top: 0.5rem;"></div>
                    <div id="shutdown-result" class="status-message" style="display: none; margin-top: 0.5rem;"></div>
                </div>
                
                <!-- Modem Controls -->
                <div style="text-align: center;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #495057;">Modem Controls</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button id="modem-reset-btn" class="btn btn-warning" style="padding: 0.5rem;">Reset Modem</button>
                        <button id="modemmanager-restart-btn" class="btn btn-info" style="padding: 0.5rem;">Restart ModemManager</button>
                    </div>
                    <div id="modem-reset-result" class="status-message" style="display: none; margin-top: 0.5rem;"></div>
                    <div id="modemmanager-restart-result" class="status-message" style="display: none; margin-top: 0.5rem;"></div>
                </div>
                
                <!-- Factory Reset -->
                <div style="text-align: center;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #d32f2f;">Factory Reset</h4>
                    <p style="color: #666; margin: 0 0 0.5rem 0; font-size: 0.8rem;">
                        Reset all settings to defaults
                    </p>
                    <button id="factory-reset-btn" class="btn btn-danger" style="padding: 0.5rem;">Reset to Defaults</button>
                    <div id="factory-reset-result" class="status-message" style="display: none; margin-top: 0.5rem;"></div>
                </div>
            </div>
            
            <!-- Update Section -->
            <div class="update-section">
                <h2>System Updates</h2>
                
                <!-- Auto-update Toggle -->
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #dee2e6;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <div>
                            <strong>Auto-updates at boot</strong>
                            <div style="font-size: 0.8rem; color: #6c757d;">
                                Check for updates when system starts
                            </div>
                        </div>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="auto-update-toggle" style="margin-right: 0.5rem;">
                            <span id="auto-update-status">Loading...</span>
                        </label>
                    </div>
                    <div id="auto-update-result" class="status-message" style="display: none;"></div>
                </div>
                
                <!-- Manual Update Controls -->
                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
                    <button id="check-update-btn" class="btn btn-primary">Check for Updates</button>
                    <button id="do-update-btn" class="btn btn-success" style="display: none;">Update Now</button>
                </div>
                <div id="update-status" class="status-message" style="display: none;"></div>
                <div id="update-details" style="margin-top: 1rem;"></div>
            </div>
        </div>    </div>
      <!-- Reboot Overlay -->
    <div class="overlay" id="overlay">
        <div class="overlay-content">
            <div class="spinner"></div>
            <div style="margin-top: 1rem; font-size: 1.2rem; color: var(--text-primary); font-weight: 500;">Rebooting... Please wait</div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global variables to track current WiFi state
        let currentWifiMode = 'client'; // default
        let currentWifiSSID = null;
        let currentWifiConnected = false;
        
        // Load current auth settings, WiFi status, and power settings
        fetch('/system-settings-data').then(r => r.json()).then(data => {
            if (data.auth) {
                document.getElementById('auth-username').value = data.auth.username || '';
                document.getElementById('auth-password').value = data.auth.password || '';
            }
            if (data.wifi) {
                document.getElementById('wifi-ssid').value = data.wifi.manual_ssid || '';
                document.getElementById('wifi-pass').value = data.wifi.manual_password || '';
            }
            if (data.settings) {
                document.getElementById('power-sleep-time').value = data.settings.power_monitor_sleep_time || '';
                document.getElementById('cellular-apn').value = data.settings.cellular_apn || 'internet';
                document.getElementById('cellular-username').value = data.settings.cellular_username || '';
                document.getElementById('cellular-password').value = data.settings.cellular_password || '';
                document.getElementById('cellular-mcc').value = data.settings.cellular_mcc || '';
                document.getElementById('cellular-mnc').value = data.settings.cellular_mnc || '';
            }
        });
        
        // Load WiFi mode status
        loadWifiStatus();
        
        // Load auto-update status
        loadAutoUpdateStatus();
        
        // WiFi scan button
        document.getElementById('scan-wifi-btn').addEventListener('click', scanWifiNetworks);
        
        // WiFi mode handlers
        document.querySelectorAll('input[name="wifi-mode"]').forEach(radio => {
            radio.addEventListener('change', handleModeChange);
        });
        
        // Auto-update toggle handler
        document.getElementById('auto-update-toggle').addEventListener('change', handleAutoUpdateToggle);
        
        // Password toggle handlers
        document.getElementById('toggle-wifi-pass').addEventListener('change', function() {
            const passField = document.getElementById('wifi-pass');
            passField.type = this.checked ? 'text' : 'password';
        });
        
        document.getElementById('toggle-hotspot-pass').addEventListener('change', function() {
            const passField = document.getElementById('hotspot-pass');
            passField.type = this.checked ? 'text' : 'password';
        });
        
        // WiFi SSID input handler to update connect button text
        document.getElementById('wifi-ssid').addEventListener('input', updateWifiConnectButton);
        
        // QR code will be updated only when hotspot status is loaded, not on input changes
        // Removed dynamic input listeners to prevent QR code from changing with form inputs
        
        function updateHotspotQR(ssid, password) {
            // This function now only updates QR code with provided parameters
            // It no longer reads from input fields to prevent dynamic changes
            const qrCodeDiv = document.getElementById('hotspot-qr-code');
            const qrInfoDiv = document.getElementById('hotspot-qr-info');
            
            if (!ssid) {
                qrCodeDiv.innerHTML = '<div style="color: #6c757d; font-style: italic;">No active hotspot to display</div>';
                qrInfoDiv.textContent = '';
                return;
            }
            
            // Create WiFi QR code string (WIFI:T:WPA;S:SSID;P:password;H:false;;)
            const wifiString = `WIFI:T:WPA;S:${ssid};P:${password};H:false;;`;
            
            // Generate QR code using a public API service
            const qrSize = 200;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(wifiString)}`;
            
            qrCodeDiv.innerHTML = `<img src="${qrUrl}" alt="WiFi QR Code" style="max-width: 200px; height: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;">`;
            qrInfoDiv.innerHTML = `Network: <strong>${ssid}</strong><br>Scan with your device to connect automatically`;
        }
        
        function displayActiveHotspotQR(data) {
            // Show QR code for the currently active hotspot
            const qrCodeDiv = document.getElementById('hotspot-qr-code');
            const qrInfoDiv = document.getElementById('hotspot-qr-info');
            
            if (data.mode === 'hotspot' && data.hotspot_active && data.hotspot_ssid) {
                // Display QR code for the active hotspot
                updateHotspotQR(data.hotspot_ssid, data.hotspot_password || 'rpistreamer123');
            } else if (data.mode === 'hotspot' && data.hotspot_ssid) {
                // Hotspot mode but not active - show configured hotspot
                updateHotspotQR(data.hotspot_ssid, data.hotspot_password || 'rpistreamer123');
            } else {
                // No hotspot configured or not in hotspot mode
                qrCodeDiv.innerHTML = '<div style="color: #6c757d; font-style: italic;">Configure hotspot settings to generate QR code</div>';
                qrInfoDiv.textContent = '';
            }
        }
        
        function loadAutoUpdateStatus() {
            fetch('/system-settings-auto-update-status')
                .then(r => r.json())
                .then(data => {
                    const toggle = document.getElementById('auto-update-toggle');
                    const status = document.getElementById('auto-update-status');
                    
                    toggle.checked = data.enabled || false;
                    status.textContent = data.enabled ? 'Enabled' : 'Disabled';
                    status.style.color = data.enabled ? '#28a745' : '#6c757d';
                })
                .catch(error => {
                    console.error('Error loading auto-update status:', error);
                    document.getElementById('auto-update-status').textContent = 'Error loading status';
                });
        }
        
        function handleAutoUpdateToggle() {
            const toggle = document.getElementById('auto-update-toggle');
            const status = document.getElementById('auto-update-status');
            const resultDiv = document.getElementById('auto-update-result');
            
            const newState = toggle.checked;
            
            // Show updating message
            resultDiv.textContent = newState ? 'Enabling automatic updates...' : 'Disabling automatic updates...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            toggle.disabled = true;
            
            fetch('/system-settings-auto-update-toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: newState })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    status.textContent = newState ? 'Enabled' : 'Disabled';
                    status.style.color = newState ? '#28a745' : '#6c757d';
                    resultDiv.textContent = data.message || `Automatic updates ${newState ? 'enabled' : 'disabled'} successfully`;
                    resultDiv.className = 'status-message status-success';
                } else {
                    // Revert toggle state on error
                    toggle.checked = !newState;
                    resultDiv.textContent = data.error || 'Failed to update auto-update setting';
                    resultDiv.className = 'status-message status-error';
                }
            })
            .catch(error => {
                // Revert toggle state on error
                toggle.checked = !newState;
                resultDiv.textContent = 'Error updating auto-update setting: ' + error.message;
                resultDiv.className = 'status-message status-error';
            })
            .finally(() => {
                toggle.disabled = false;
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            });
        }
        
        function updateWifiConnectButton() {
            const wifiConnectBtn = document.getElementById('wifi-connect-btn');
            const enteredSSID = document.getElementById('wifi-ssid').value.trim();
            
            if (currentWifiConnected && currentWifiSSID) {
                if (enteredSSID === currentWifiSSID) {
                    wifiConnectBtn.textContent = 'Reconnect to Network';
                    wifiConnectBtn.className = 'btn btn-info';
                } else if (enteredSSID) {
                    wifiConnectBtn.textContent = 'Switch Network';
                    wifiConnectBtn.className = 'btn btn-warning';
                } else {
                    wifiConnectBtn.textContent = 'Connect to Network';
                    wifiConnectBtn.className = 'btn btn-primary';
                }
            } else {
                wifiConnectBtn.textContent = 'Connect to Network';
                wifiConnectBtn.className = 'btn btn-primary';
            }
        }
        
        function scanWifiNetworks() {
            const scanBtn = document.getElementById('scan-wifi-btn');
            const scanStatus = document.getElementById('scan-status');
            const networksDiv = document.getElementById('wifi-networks');
            
            scanBtn.disabled = true;
            scanStatus.textContent = 'Scanning for WiFi networks...';
            networksDiv.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666;">Scanning...</div>';
            
            fetch('/system-settings-wifi-scan')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.networks) {
                        displayWifiNetworks(data.networks);
                        scanStatus.textContent = `Found ${data.networks.length} networks`;
                    } else {
                        networksDiv.innerHTML = '<div style="text-align: center; padding: 1rem; color: #dc3545;">Failed to scan networks</div>';
                        scanStatus.textContent = data.error || 'Scan failed';
                    }
                })
                .catch(error => {
                    networksDiv.innerHTML = '<div style="text-align: center; padding: 1rem; color: #dc3545;">Error scanning networks</div>';
                    scanStatus.textContent = 'Scan failed: ' + error.message;
                })
                .finally(() => {
                    scanBtn.disabled = false;
                });
        }
        
        function displayWifiNetworks(networks) {
            const networksDiv = document.getElementById('wifi-networks');
            
            if (networks.length === 0) {
                networksDiv.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666;">No networks found</div>';
                return;
            }
            
            let html = '';
            networks.forEach((network, index) => {
                const signalBars = getSignalBars(network.signal);
                const securityIcon = network.security ? 'üîí' : 'üîì';
                const isConnected = network.in_use;
                
                html += `
                    <div class="wifi-network" style="border: 1px solid #ddd; border-radius: 0.25rem; padding: 1rem; margin-bottom: 0.5rem; ${isConnected ? 'background-color: #e8f5e9;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <strong>${network.ssid || '(Hidden Network)'}</strong>
                                ${isConnected ? '<span style="color: #28a745; font-size: 0.8rem; margin-left: 0.5rem;">‚óè Connected</span>' : ''}
                                <div style="font-size: 0.8rem; color: #666;">
                                    ${securityIcon} ${network.security || 'Open'} ‚Ä¢ Channel ${network.channel} ‚Ä¢ ${signalBars}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.8rem; color: #666;">${network.signal}%</div>
                                <div style="font-size: 0.7rem;">${signalBars}</div>
                            </div>
                        </div>
                        
                        ${!isConnected ? `
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${network.security ? `
                                    <input type="password" id="pass-${index}" placeholder="Password" style="flex: 1; padding: 0.25rem; border: 1px solid #ccc; border-radius: 0.25rem;">
                                    <label style="font-size: 0.8rem;">
                                        <input type="checkbox" class="password-toggle" data-target="pass-${index}"> Show
                                    </label>
                                ` : '<div style="flex: 1; color: #666; font-style: italic;">No password required</div>'}
                                <button class="btn btn-primary connect-btn" style="padding: 0.25rem 0.75rem;" data-ssid="${network.ssid}" data-has-password="${network.security ? 'true' : 'false'}" data-index="${index}">
                                    Connect
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            networksDiv.innerHTML = html;
            
            // Add event listeners for password toggle checkboxes
            document.querySelectorAll('.password-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetInput = document.getElementById(targetId);
                    if (targetInput) {
                        targetInput.type = this.checked ? 'text' : 'password';
                    }
                });
            });
            
            // Add event listeners for connect buttons
            document.querySelectorAll('.connect-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const ssid = this.getAttribute('data-ssid');
                    const hasPassword = this.getAttribute('data-has-password');
                    const index = this.getAttribute('data-index');
                    connectToNetwork(ssid, hasPassword, index);
                });
            });
        }
        
        function getSignalBars(signal) {
            // Create CSS-based signal bars for perfect alignment
            let color = '';
            let bars = [false, false, false, false]; // 4 bars
            
            if (signal >= 90) {
                bars = [true, true, true, true];
                color = '#28a745'; // Strong green
            } else if (signal >= 75) {
                bars = [true, true, true, true];
                color = '#28a745'; // Green
            } else if (signal >= 60) {
                bars = [true, true, true, false];
                color = '#ffc107'; // Yellow
            } else if (signal >= 45) {
                bars = [true, true, false, false];
                color = '#fd7e14'; // Orange
            } else if (signal >= 30) {
                bars = [true, false, false, false];
                color = '#dc3545'; // Red
            } else {
                bars = [false, false, false, false];
                color = '#6c757d'; // Gray
            }
            
            // Create CSS bars with perfect bottom alignment
            let barHtml = '<span style="display: inline-flex; align-items: flex-end; gap: 1px; height: 12px;">';
            const heights = ['3px', '6px', '9px', '12px'];
            
            bars.forEach((active, index) => {
                const opacity = active ? '1' : '0.3';
                barHtml += `<div style="width: 2px; height: ${heights[index]}; background-color: ${color}; opacity: ${opacity};"></div>`;
            });
            
            barHtml += '</span>';
            return barHtml;
        }
        
        function togglePassword(inputId, show) {
            const input = document.getElementById(inputId);
            if (input) {
                input.type = show ? 'text' : 'password';
            }
        }
        
        function connectToNetwork(ssid, hasPassword, index) {
            const password = hasPassword === 'true' ? document.getElementById(`pass-${index}`).value : '';
            const connectBtn = document.querySelector(`[data-index="${index}"]`);
            
            if (hasPassword === 'true' && !password) {
                alert('Please enter the password for this network');
                return;
            }
            
            // Provide immediate visual feedback on the connect button
            const originalText = connectBtn.textContent;
            const originalClass = connectBtn.className;
            connectBtn.textContent = 'Connecting...';
            connectBtn.className = 'btn btn-secondary';
            connectBtn.disabled = true;
            
            // Add a subtle animation to the button
            connectBtn.style.opacity = '0.7';
            
            // Update the manual form fields and submit
            document.getElementById('wifi-ssid').value = ssid;
            document.getElementById('wifi-pass').value = password;
            document.getElementById('wifi-pass').required = hasPassword === 'true';
            
            // Update the connect button text based on the selected network
            updateWifiConnectButton();
            
            // Store button reference for restoration later
            window.currentConnectingBtn = { btn: connectBtn, originalText, originalClass };
            
            // Trigger the existing form submission
            document.getElementById('wifi-form').dispatchEvent(new Event('submit'));
        }
        
        function loadWifiStatus() {
            fetch('/system-settings-wifi-status')
                .then(r => r.json())
                .then(data => {
                    // Store current mode and connection info globally
                    currentWifiMode = data.mode || 'client';
                    currentWifiSSID = data.current_ssid || null;
                    currentWifiConnected = !!(data.mode === 'client' && data.current_ip);
                    
                    // Set current mode
                    const modeRadio = document.getElementById(data.mode === 'hotspot' ? 'mode-hotspot' : 'mode-client');
                    modeRadio.checked = true;
                    
                    // Load hotspot settings
                    document.getElementById('hotspot-ssid').value = data.hotspot_ssid || 'RPI-Streamer';
                    document.getElementById('hotspot-ip').value = data.hotspot_ip || '192.168.4.1';
                    
                    // Update QR code to show the currently active/configured hotspot
                    displayActiveHotspotQR(data);
                    
                    // Show appropriate settings panel
                    handleModeChange();
                    
                    // Update status display
                    const statusDiv = document.getElementById('wifi-status');
                    if (data.mode === 'hotspot' && data.hotspot_active) {
                        statusDiv.textContent = `Hotspot "${data.hotspot_ssid}" active at ${data.current_ip || data.hotspot_ip}`;
                        statusDiv.className = 'status-message status-success';
                    } else if (data.mode === 'client' && data.current_ip) {
                        const networkName = data.current_ssid ? `"${data.current_ssid}"` : 'WiFi';
                        statusDiv.textContent = `Connected to ${networkName} - IP: ${data.current_ip}`;
                        statusDiv.className = 'status-message status-success';
                    } else if (data.mode === 'client') {
                        statusDiv.textContent = 'Client mode - Not connected';
                        statusDiv.className = 'status-message status-warning';
                    } else {
                        statusDiv.textContent = 'Hotspot mode - Not active';
                        statusDiv.className = 'status-message status-warning';
                    }
                    statusDiv.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading WiFi status:', error);
                });
        }
        
        function handleModeChange() {
            const selectedMode = document.querySelector('input[name="wifi-mode"]:checked').value;
            const clientSettings = document.getElementById('client-settings');
            const hotspotSettings = document.getElementById('hotspot-settings');
            const hotspotBtn = document.getElementById('hotspot-submit-btn');
            const wifiConnectBtn = document.getElementById('wifi-connect-btn');
            
            // Show/hide appropriate settings panel
            if (selectedMode === 'client') {
                clientSettings.style.display = 'block';
                hotspotSettings.style.display = 'none';
                
                // Update WiFi connect button text based on current connection state
                updateWifiConnectButton();
            } else {
                clientSettings.style.display = 'none';
                hotspotSettings.style.display = 'block';
                
                // QR code will be shown based on loaded WiFi status, not generated here
                
                // Update hotspot button text based on current mode
                if (currentWifiMode === 'hotspot') {
                    hotspotBtn.textContent = 'Update Hotspot Settings';
                    hotspotBtn.className = 'btn btn-success';
                } else {
                    hotspotBtn.textContent = 'Activate Hotspot';
                    hotspotBtn.className = 'btn btn-primary';
                }
            }
        }
        
        // Auth form submit
        document.getElementById('auth-form').onsubmit = function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('auth-result');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Show updating message
            resultDiv.textContent = 'Updating authentication settings...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            fetch('/system-settings-auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: document.getElementById('auth-username').value,
                    password: document.getElementById('auth-password').value                })
            }).then(r => r.json()).then(data => {
                const message = data.message || (data.success ? 'Authentication settings saved!' : (data.error || 'Error saving settings'));
                resultDiv.textContent = message;
                resultDiv.className = data.success ? 'status-message status-success' : 'status-message status-error';
                resultDiv.style.display = 'block';
            }).catch(error => {
                resultDiv.textContent = 'Error updating authentication settings: ' + error.message;
                resultDiv.className = 'status-message status-error';
                resultDiv.style.display = 'block';
            }).finally(() => {
                submitBtn.disabled = false;
            });
        };
        
        // Power settings form submit
        document.getElementById('power-settings-form').onsubmit = function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('power-settings-result');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const sleepTimeInput = document.getElementById('power-sleep-time');
            
            // Validate input
            const sleepTime = parseInt(sleepTimeInput.value);
            if (isNaN(sleepTime) || sleepTime < 0 || sleepTime > 3600) {
                resultDiv.textContent = 'Grace period must be between 0 and 3600 seconds';
                resultDiv.className = 'status-message status-error';
                resultDiv.style.display = 'block';
                return;
            }
            
            // Show updating message
            resultDiv.textContent = 'Updating power management settings...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            fetch('/system-settings-power', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    power_monitor_sleep_time: sleepTime
                })
            }).then(r => r.json()).then(data => {
                let message;
                if (data.success) {
                    if (sleepTime === 0) {
                        message = 'Power monitoring disabled successfully!';
                    } else {
                        message = `Grace period set to ${sleepTime} seconds successfully!`;
                    }
                } else {
                    message = data.error || 'Error saving power settings';
                }
                resultDiv.textContent = message;
                resultDiv.className = data.success ? 'status-message status-success' : 'status-message status-error';
                resultDiv.style.display = 'block';
            }).catch(error => {
                resultDiv.textContent = 'Error updating power settings: ' + error.message;
                resultDiv.className = 'status-message status-error';
                resultDiv.style.display = 'block';
            }).finally(() => {
                submitBtn.disabled = false;
            });
        };
          // WiFi client form submit
        document.getElementById('wifi-form').onsubmit = function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('wifi-result');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Show updating message
            resultDiv.textContent = 'Connecting to WiFi network...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            fetch('/system-settings-wifi', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ssid: document.getElementById('wifi-ssid').value,
                    password: document.getElementById('wifi-pass').value
                })
            }).then(r => r.json()).then(data => {
                resultDiv.textContent = data.success ? 'Connected to WiFi network!' : (data.error || 'Connection failed');
                resultDiv.className = data.success ? 'status-message status-success' : 'status-message status-error';
                resultDiv.style.display = 'block';
                
                // Restore the network list connect button if it was clicked
                if (window.currentConnectingBtn) {
                    const { btn, originalText, originalClass } = window.currentConnectingBtn;
                    if (data.success) {
                        btn.textContent = 'Connected';
                        btn.className = 'btn btn-success';
                        btn.disabled = true;
                    } else {
                        btn.textContent = originalText;
                        btn.className = originalClass;
                        btn.disabled = false;
                    }
                    btn.style.opacity = '1';
                    window.currentConnectingBtn = null;
                }
                
                if (data.success) {
                    setTimeout(() => {
                        loadWifiStatus();
                        // Refresh the network list to show connected status
                        scanWifiNetworks();
                    }, 2000);
                }
            }).catch(error => {
                resultDiv.textContent = 'Error connecting to WiFi: ' + error.message;
                resultDiv.className = 'status-message status-error';
                resultDiv.style.display = 'block';
                
                // Restore the network list connect button on error
                if (window.currentConnectingBtn) {
                    const { btn, originalText, originalClass } = window.currentConnectingBtn;
                    btn.textContent = originalText;
                    btn.className = originalClass;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    window.currentConnectingBtn = null;
                }
            }).finally(() => {
                submitBtn.disabled = false;
            });
        };
        
        // Hotspot form submit (applies settings and activates hotspot)
        document.getElementById('hotspot-form').onsubmit = function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('hotspot-result');
            const submitBtn = document.getElementById('hotspot-submit-btn');
            
            if (document.getElementById('hotspot-pass').value.length < 8) {
                resultDiv.textContent = 'Password must be at least 8 characters';
                resultDiv.className = 'status-message status-error';
                resultDiv.style.display = 'block';
                return;
            }
            
            resultDiv.textContent = 'Applying hotspot settings...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            // Add a progress indicator
            let dots = 0;
            const progressInterval = setInterval(() => {
                dots = (dots + 1) % 4;
                resultDiv.textContent = `Applying hotspot settings${'.'.repeat(dots)}`;
            }, 500);
            
            const requestData = {
                mode: 'hotspot',
                hotspot_ssid: document.getElementById('hotspot-ssid').value,
                hotspot_password: document.getElementById('hotspot-pass').value,
                hotspot_channel: document.getElementById('hotspot-channel').value,
                hotspot_ip: document.getElementById('hotspot-ip').value
            };
            
            // Create AbortController for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 120000); // 2 minute timeout
            
            fetch('/system-settings-wifi-mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData),
                signal: controller.signal
            })
            .then(r => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                if (!r.ok) {
                    throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                }
                return r.json();
            })
            .then(data => {
                resultDiv.textContent = data.message || (data.success ? 'Hotspot settings applied successfully!' : data.error);
                resultDiv.className = data.success ? 'status-message status-success' : 'status-message status-error';
                
                if (data.success) {
                    // Reload status after a moment
                    setTimeout(loadWifiStatus, 2000);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                if (error.name === 'AbortError') {
                    resultDiv.textContent = 'Request timed out. The hotspot configuration may still be in progress. Check the status in a few minutes.';
                } else {
                    resultDiv.textContent = 'Error applying hotspot settings: ' + error.message;
                }
                resultDiv.className = 'status-message status-error';
            })
            .finally(() => {
                submitBtn.disabled = false;
            });
        };

        // Cellular settings form handler
        document.getElementById('cellular-settings-form').onsubmit = function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('cellular-result');
            const submitBtn = this.querySelector('button[type="submit"]');
            
            resultDiv.textContent = 'Saving cellular settings...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            const requestData = {
                cellular_apn: document.getElementById('cellular-apn').value,
                cellular_username: document.getElementById('cellular-username').value,
                cellular_password: document.getElementById('cellular-password').value,
                cellular_mcc: document.getElementById('cellular-mcc').value,
                cellular_mnc: document.getElementById('cellular-mnc').value
            };
            
            fetch('/flight-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(r => r.json())
            .then(data => {
                resultDiv.textContent = data.message || (data.success ? 'Cellular settings saved successfully!' : data.error);
                resultDiv.className = data.success ? 'status-message status-success' : 'status-message status-error';
            })
            .catch(error => {
                resultDiv.textContent = 'Error saving cellular settings: ' + error.message;
                resultDiv.className = 'status-message status-error';
            })
            .finally(() => {
                submitBtn.disabled = false;
            });
        };

        // Reboot button
        document.getElementById('reboot-btn').onclick = function() {
            if (!confirm('Are you sure you want to reboot the system?')) return;
            const resultDiv = document.getElementById('reboot-result');
            const rebootBtn = document.getElementById('reboot-btn');
            
            // Show updating message
            resultDiv.textContent = 'Initiating system reboot...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            rebootBtn.disabled = true;
            
            fetch('/system-settings-reboot', { method: 'POST' })
                .then(r => r.json())
                .then(function(data) {                    if (data.success) {
                        resultDiv.textContent = 'System rebooting...';
                        resultDiv.className = 'status-message status-success';
                        // Show overlay and start polling
                        document.getElementById('overlay').style.display = 'flex';
                        setTimeout(function pollForReload() {
                            fetch(window.location.href, {cache: 'no-store'})
                                .then(r => {
                                    if (r.ok) {
                                        window.location.reload();
                                    } else {
                                        setTimeout(pollForReload, 2000);
                                    }
                                })
                                .catch(() => setTimeout(pollForReload, 2000));
                        }, 5000); // Wait 5s before first poll
                    } else {
                        resultDiv.textContent = data.error || 'Reboot failed';
                        resultDiv.className = 'status-message status-error';
                        resultDiv.style.display = 'block';
                        rebootBtn.disabled = false;
                    }
                }).catch(error => {
                    resultDiv.textContent = 'Error initiating reboot: ' + error.message;
                    resultDiv.className = 'status-message status-error';
                    resultDiv.style.display = 'block';
                    rebootBtn.disabled = false;
                });
        };
        
        // Shutdown button
        document.getElementById('shutdown-btn').onclick = function() {
            if (!confirm('Are you sure you want to shutdown the system?')) return;
            const resultDiv = document.getElementById('shutdown-result');
            const shutdownBtn = document.getElementById('shutdown-btn');
            
            // Show updating message
            resultDiv.textContent = 'Initiating system shutdown...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            shutdownBtn.disabled = true;
            
            fetch('/system-settings-shutdown', { method: 'POST' })
                .then(r => r.json())
                .then(function(data) {
                    if (data.success) {
                        resultDiv.textContent = 'System shutting down...';
                        resultDiv.className = 'status-message status-success';
                        // Show overlay for shutdown (no polling needed as system will be off)
                        document.getElementById('overlay').style.display = 'flex';
                        document.querySelector('#overlay div').innerHTML = '<div style="margin-top: 1rem; font-size: 1.2rem; color: var(--text-primary); font-weight: 500;">Shutting down... System will be offline</div>';
                    } else {
                        resultDiv.textContent = data.error || 'Shutdown failed';
                        resultDiv.className = 'status-message status-error';
                        resultDiv.style.display = 'block';
                        shutdownBtn.disabled = false;
                    }
                }).catch(error => {
                    resultDiv.textContent = 'Error initiating shutdown: ' + error.message;
                    resultDiv.className = 'status-message status-error';
                    resultDiv.style.display = 'block';
                    shutdownBtn.disabled = false;
                });
        };
        
        // Modem Reset button
        document.getElementById('modem-reset-btn').onclick = function() {
            if (!confirm('Are you sure you want to reset the modem? This will power cycle the USB port.')) return;
            
            const resultDiv = document.getElementById('modem-reset-result');
            const resetBtn = document.getElementById('modem-reset-btn');
            
            // Show updating message
            resultDiv.textContent = 'Resetting modem...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            resetBtn.disabled = true;
            
            fetch('/system-settings-modem-reset', { method: 'POST' })
                .then(r => r.json())
                .then(function(data) {
                    if (data.success) {
                        resultDiv.textContent = data.message || 'Modem reset successful';
                        resultDiv.className = 'status-message status-success';
                    } else {
                        resultDiv.textContent = data.error || 'Modem reset failed';
                        resultDiv.className = 'status-message status-error';
                    }
                }).catch(error => {
                    resultDiv.textContent = 'Error resetting modem: ' + error.message;
                    resultDiv.className = 'status-message status-error';
                }).finally(() => {
                    resetBtn.disabled = false;
                });
        };
        
        // ModemManager Restart button
        document.getElementById('modemmanager-restart-btn').onclick = function() {
            if (!confirm('Are you sure you want to restart ModemManager? This will briefly interrupt modem connectivity.')) return;
            
            const resultDiv = document.getElementById('modemmanager-restart-result');
            const restartBtn = document.getElementById('modemmanager-restart-btn');
            
            // Show updating message
            resultDiv.textContent = 'Restarting ModemManager...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            restartBtn.disabled = true;
            
            fetch('/system-settings-modemmanager-restart', { method: 'POST' })
                .then(r => r.json())
                .then(function(data) {
                    if (data.success) {
                        resultDiv.textContent = data.message || 'ModemManager restarted successfully';
                        resultDiv.className = 'status-message status-success';
                    } else {
                        resultDiv.textContent = data.error || 'ModemManager restart failed';
                        resultDiv.className = 'status-message status-error';
                    }
                }).catch(error => {
                    resultDiv.textContent = 'Error restarting ModemManager: ' + error.message;
                    resultDiv.className = 'status-message status-error';
                }).finally(() => {
                    restartBtn.disabled = false;
                });
        };

        // Factory Reset button
        document.getElementById('factory-reset-btn').onclick = function() {
            if (!confirm('Are you sure you want to reset all settings to factory defaults? This cannot be undone!')) return;
            if (!confirm('This will erase ALL settings including WiFi, authentication, and configuration. Are you absolutely sure?')) return;
            
            const resultDiv = document.getElementById('factory-reset-result');
            const resetBtn = document.getElementById('factory-reset-btn');
            
            // Show updating message
            resultDiv.textContent = 'Resetting to factory defaults...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            resetBtn.disabled = true;
            
            fetch('/system-settings-factory-reset', { method: 'POST' })
                .then(r => r.json())
                .then(function(data) {
                    if (data.success) {
                        resultDiv.textContent = 'Factory reset complete. System will reload...';
                        resultDiv.className = 'status-message status-success';
                        // Reload the page after a short delay
                        setTimeout(function() {
                            window.location.reload();
                        }, 2000);
                    } else {
                        resultDiv.textContent = data.error || 'Factory reset failed';
                        resultDiv.className = 'status-message status-error';
                        resetBtn.disabled = false;
                    }
                }).catch(error => {
                    resultDiv.textContent = 'Error during factory reset: ' + error.message;
                    resultDiv.className = 'status-message status-error';
                    resetBtn.disabled = false;
                });
        };
        
        // Check for Updates button
        var checkUpdateBtn = document.getElementById('check-update-btn');
        var updateStatus = document.getElementById('update-status');
        var updateDetails = document.getElementById('update-details');
        var doUpdateBtn = document.getElementById('do-update-btn');
        
        if (checkUpdateBtn) {
            checkUpdateBtn.onclick = function() {
                updateStatus.textContent = 'Checking for updates...';
                updateStatus.className = 'status-message';
                updateStatus.style.display = 'block';
                updateDetails.innerHTML = '';
                
                fetch('/system-check-update', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            updateStatus.textContent = data.summary;
                            updateStatus.className = 'status-message status-success';
                            
                            if (data.updates === true) {
                                doUpdateBtn.style.display = 'inline-block';
                                // Show update details if present
                                if (data.details && data.details.length > 0) {
                                    updateDetails.innerHTML = '<pre style="white-space:pre-wrap;word-break:break-all; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">' + data.details + '</pre>';
                                }
                            } else {
                                updateDetails.innerHTML = '';
                                doUpdateBtn.style.display = 'none';
                            }
                        } else {
                            updateStatus.textContent = data.error || 'Update check failed.';
                            updateStatus.className = 'status-message status-error';
                            updateDetails.innerHTML = '';
                            doUpdateBtn.style.display = 'none';
                        }
                    })
                    .catch(e => {
                        updateStatus.textContent = 'Update check failed.';
                        updateStatus.className = 'status-message status-error';
                        updateDetails.innerHTML = '';
                        doUpdateBtn.style.display = 'none';
                    });
            };
        }
        
        if (doUpdateBtn) {
            doUpdateBtn.onclick = function() {
                doUpdateBtn.disabled = true;
                updateStatus.textContent = 'Updating...';
                updateStatus.className = 'status-message';
                updateDetails.innerHTML = '';
                
                fetch('/system-do-update', { method: 'POST' })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        let statusSet = false;
                        if (data.success) {
                            updateStatus.textContent = 'Update complete!';
                            updateStatus.className = 'status-message status-success';
                            statusSet = true;
                            // After successful update, call /system-restart-services (fire and forget)
                            fetch('/system-restart-services', { method: 'POST' });
                        } else if (data.results && data.results.length > 0) {
                            let found = data.results.find(x => /update (complete|successful|succeeded)/i.test(x));
                            if (found) {
                                updateStatus.textContent = found;
                                updateStatus.className = 'status-message status-success';
                                statusSet = true;
                            }
                        }
                        if (!statusSet) {
                            updateStatus.textContent = data.error || 'Update failed.';
                            updateStatus.className = 'status-message status-error';
                        }
                        
                        if (data.results && data.results.length > 0) {
                            let html = '<div style="margin-top:1rem;"><strong>Update Results:</strong><ul style="text-align: left; margin-top: 0.5rem;">';
                            data.results.forEach(function(res) {
                                html += `<li>${res}</li>`;
                            });
                            html += '</ul></div>';
                            updateDetails.innerHTML = html;
                        }
                        
                        if (data.traceback) {
                            updateDetails.innerHTML += `<pre style="color: var(--accent-color); white-space: pre-wrap; word-break: break-all; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;"><strong>Traceback:</strong>\n${data.traceback}</pre>`;
                        }
                        
                        doUpdateBtn.disabled = false;
                    })
                    .catch(function(e) {
                        let msg = (e && e.message) ? e.message : (typeof e === 'string' ? e : (e && e.toString ? e.toString() : 'Network or server error.'));
                        updateStatus.textContent = 'Update failed: ' + msg;
                        updateStatus.className = 'status-message status-error';
                        updateDetails.innerHTML = '<pre style="color: var(--accent-color); white-space: pre-wrap; word-break: break-all; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">' + msg + '</pre>';
                        doUpdateBtn.disabled = false;
                    });
            };
        }
        
        // Auth password visibility toggle
        document.getElementById('toggle-auth-pass').onchange = function() {
            document.getElementById('auth-password').type = this.checked ? 'text' : 'password';
        };
    });
    </script>
</body>
</html>
