<!DOCTYPE html>
<html lang="en">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - RPI Streamer</title>
</head>
<body>
    {% include 'navbar.html' %}
    
    <div class="container">
        <div class="frame">
            <h1>System Settings</h1>
            
            <!-- Authentication Settings -->            <form id="auth-form">
                <h2>Basic Authentication</h2>
                <label for="auth-username">Username</label>
                <input type="text" id="auth-username" name="username" required>
                
                <label for="auth-password">Password</label>
                <p class="help-text" style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-secondary);">
                    Leave password blank to disable authentication completely.
                </p>
                <div style="position: relative;">
                    <input type="password" id="auth-password" name="password">
                    <label style="display: inline-flex; align-items: center; margin-top: 0.5rem; font-size: 0.9rem;">
                        <input type="checkbox" id="toggle-auth-pass" style="margin-right: 0.5rem;"> Show Password
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">Save Auth Settings</button>
                <div id="auth-result" class="status-message" style="display: none;"></div>
            </form>
        </div>
        
        <div class="frame">
            <!-- WiFi Management -->
            <h2>WiFi Management</h2>
            
            <!-- WiFi Mode Selection -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">WiFi Mode</label>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center;">
                        <input type="radio" name="wifi-mode" value="client" id="mode-client" style="margin-right: 0.5rem;">
                        Client Mode (Connect to existing WiFi)
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="radio" name="wifi-mode" value="hotspot" id="mode-hotspot" style="margin-right: 0.5rem;">
                        Hotspot Mode (Create WiFi network)
                    </label>
                </div>
                <div id="wifi-status" class="status-message" style="margin-bottom: 1rem;"></div>
            </div>
            
            <!-- Client Mode Settings -->
            <div id="client-settings" style="display: none;">
                <form id="wifi-form">
                    <h3>Client WiFi Settings</h3>
                    <label for="wifi-ssid">SSID</label>
                    <input type="text" id="wifi-ssid" name="ssid" required>
                    
                    <label for="wifi-pass">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="wifi-pass" name="wifi_password" required>
                        <label style="display: inline-flex; align-items: center; margin-top: 0.5rem; font-size: 0.9rem;">
                            <input type="checkbox" id="toggle-wifi-pass" style="margin-right: 0.5rem;"> Show Password
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save WiFi Settings</button>
                    <div id="wifi-result" class="status-message" style="display: none;"></div>
                </form>
            </div>
            
            <!-- Hotspot Mode Settings -->
            <div id="hotspot-settings" style="display: none;">
                <form id="hotspot-form">
                    <h3>Hotspot Settings</h3>
                    <label for="hotspot-ssid">Hotspot Name (SSID)</label>
                    <input type="text" id="hotspot-ssid" name="hotspot_ssid" value="RPI-Streamer" required>
                    
                    <label for="hotspot-pass">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="hotspot-pass" name="hotspot_password" value="rpistreamer123" required minlength="8">
                        <label style="display: inline-flex; align-items: center; margin-top: 0.5rem; font-size: 0.9rem;">
                            <input type="checkbox" id="toggle-hotspot-pass" style="margin-right: 0.5rem;"> Show Password
                        </label>
                    </div>
                    <p class="help-text" style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-secondary);">
                        Password must be at least 8 characters long.
                    </p>
                    
                    <div style="display: flex; gap: 1rem;">
                        <div style="flex: 1;">
                            <label for="hotspot-channel">WiFi Channel</label>
                            <select id="hotspot-channel" name="hotspot_channel">
                                <option value="1">1</option>
                                <option value="6" selected>6</option>
                                <option value="11">11</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label for="hotspot-ip">IP Address</label>
                            <input type="text" id="hotspot-ip" name="hotspot_ip" value="192.168.4.1" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Create Hotspot</button>
                    <div id="hotspot-result" class="status-message" style="display: none;"></div>
                </form>
            </div>
            
            <!-- Mode Switch Controls -->
            <div id="mode-controls" style="margin-top: 1.5rem; text-align: center;">
                <button id="apply-mode-btn" class="btn btn-success" style="display: none;">Apply WiFi Mode</button>
                <div id="mode-result" class="status-message" style="display: none; margin-top: 1rem;"></div>
            </div>
        </div>
        
        <div class="frame">
            <!-- System Controls -->
            <h2>System Controls</h2>
            <div style="text-align: center; margin-bottom: 2rem;">
                <button id="reboot-btn" class="btn btn-danger">Reboot System</button>
                <div id="reboot-result" class="status-message" style="display: none;"></div>
            </div>
            
            <!-- Update Section -->
            <div class="update-section">
                <h2>System Updates</h2>
                <div style="text-align: center; margin-bottom: 1rem;">
                    <button id="check-update-btn" class="btn btn-primary">Check for Updates</button>
                    <button id="do-update-btn" class="btn btn-success" style="display: none;">Update Now</button>
                </div>
                <div id="update-status" class="status-message" style="display: none;"></div>
                <div id="update-details" style="margin-top: 1rem;"></div>
            </div>
        </div>    </div>
      <!-- Reboot Overlay -->
    <div class="overlay" id="overlay">
        <div class="overlay-content">
            <div class="spinner"></div>
            <div style="margin-top: 1rem; font-size: 1.2rem; color: var(--text-primary); font-weight: 500;">Rebooting... Please wait</div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load current auth settings and WiFi status
        fetch('/system-settings-data').then(r => r.json()).then(data => {
            if (data.auth) {
                document.getElementById('auth-username').value = data.auth.username || '';
                document.getElementById('auth-password').value = data.auth.password || '';
            }
            if (data.wifi) {
                document.getElementById('wifi-ssid').value = data.wifi.ssid || '';
                document.getElementById('wifi-pass').value = data.wifi.password || '';
            }
        });
        
        // Load WiFi mode status
        loadWifiStatus();
        
        // WiFi mode handlers
        document.querySelectorAll('input[name="wifi-mode"]').forEach(radio => {
            radio.addEventListener('change', handleModeChange);
        });
        
        // Password toggle handlers
        document.getElementById('toggle-wifi-pass').addEventListener('change', function() {
            const passField = document.getElementById('wifi-pass');
            passField.type = this.checked ? 'text' : 'password';
        });
        
        document.getElementById('toggle-hotspot-pass').addEventListener('change', function() {
            const passField = document.getElementById('hotspot-pass');
            passField.type = this.checked ? 'text' : 'password';
        });
        
        function loadWifiStatus() {
            fetch('/system-settings-wifi-status')
                .then(r => r.json())
                .then(data => {
                    // Set current mode
                    const modeRadio = document.getElementById(data.mode === 'hotspot' ? 'mode-hotspot' : 'mode-client');
                    modeRadio.checked = true;
                    
                    // Load hotspot settings
                    document.getElementById('hotspot-ssid').value = data.hotspot_ssid || 'RPI-Streamer';
                    document.getElementById('hotspot-ip').value = data.hotspot_ip || '192.168.4.1';
                    
                    // Show appropriate settings panel
                    handleModeChange();
                    
                    // Update status display
                    const statusDiv = document.getElementById('wifi-status');
                    if (data.mode === 'hotspot' && data.hostapd_active) {
                        statusDiv.textContent = `Hotspot "${data.hotspot_ssid}" active at ${data.current_ip || data.hotspot_ip}`;
                        statusDiv.className = 'status-message status-success';
                    } else if (data.mode === 'client' && data.current_ip) {
                        statusDiv.textContent = `Connected to WiFi - IP: ${data.current_ip}`;
                        statusDiv.className = 'status-message status-success';
                    } else if (data.mode === 'client') {
                        statusDiv.textContent = 'Client mode - Not connected';
                        statusDiv.className = 'status-message status-warning';
                    } else {
                        statusDiv.textContent = 'Hotspot mode - Not active';
                        statusDiv.className = 'status-message status-warning';
                    }
                    statusDiv.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading WiFi status:', error);
                });
        }
        
        function handleModeChange() {
            const selectedMode = document.querySelector('input[name="wifi-mode"]:checked').value;
            const clientSettings = document.getElementById('client-settings');
            const hotspotSettings = document.getElementById('hotspot-settings');
            const applyBtn = document.getElementById('apply-mode-btn');
            
            if (selectedMode === 'client') {
                clientSettings.style.display = 'block';
                hotspotSettings.style.display = 'none';
                applyBtn.textContent = 'Switch to Client Mode';
            } else {
                clientSettings.style.display = 'none';
                hotspotSettings.style.display = 'block';
                applyBtn.textContent = 'Switch to Hotspot Mode';
            }
            
            applyBtn.style.display = 'block';
        }
        
        // Apply mode button handler
        document.getElementById('apply-mode-btn').addEventListener('click', function() {
            const selectedMode = document.querySelector('input[name="wifi-mode"]:checked').value;
            const resultDiv = document.getElementById('mode-result');
            const applyBtn = this;
            
            resultDiv.textContent = `Switching to ${selectedMode} mode...`;
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            applyBtn.disabled = true;
            
            const requestData = { mode: selectedMode };
            
            if (selectedMode === 'hotspot') {
                requestData.hotspot_ssid = document.getElementById('hotspot-ssid').value;
                requestData.hotspot_password = document.getElementById('hotspot-pass').value;
                requestData.hotspot_channel = document.getElementById('hotspot-channel').value;
                requestData.hotspot_ip = document.getElementById('hotspot-ip').value;
                
                if (requestData.hotspot_password.length < 8) {
                    resultDiv.textContent = 'Hotspot password must be at least 8 characters';
                    resultDiv.className = 'status-message status-error';
                    applyBtn.disabled = false;
                    return;
                }
            }
            
            fetch('/system-settings-wifi-mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(r => r.json())
            .then(data => {
                resultDiv.textContent = data.message || (data.success ? 'WiFi mode changed successfully' : data.error);
                resultDiv.className = data.success ? 'status-message status-success' : 'status-message status-error';
                
                if (data.success) {
                    // Reload status after a moment
                    setTimeout(loadWifiStatus, 2000);
                }
            })
            .catch(error => {
                resultDiv.textContent = 'Error changing WiFi mode: ' + error.message;
                resultDiv.className = 'status-message status-error';
            })
            .finally(() => {
                applyBtn.disabled = false;
            });
        });
          // Auth form submit
        document.getElementById('auth-form').onsubmit = function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('auth-result');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Show updating message
            resultDiv.textContent = 'Updating authentication settings...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            fetch('/system-settings-auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: document.getElementById('auth-username').value,
                    password: document.getElementById('auth-password').value                })
            }).then(r => r.json()).then(data => {
                const message = data.message || (data.success ? 'Authentication settings saved!' : (data.error || 'Error saving settings'));
                resultDiv.textContent = message;
                resultDiv.className = data.success ? 'status-message status-success' : 'status-message status-error';
                resultDiv.style.display = 'block';
            }).catch(error => {
                resultDiv.textContent = 'Error updating authentication settings: ' + error.message;
                resultDiv.className = 'status-message status-error';
                resultDiv.style.display = 'block';
            }).finally(() => {
                submitBtn.disabled = false;
            });
        };
          // WiFi client form submit
        document.getElementById('wifi-form').onsubmit = function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('wifi-result');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Show updating message
            resultDiv.textContent = 'Updating WiFi settings...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            submitBtn.disabled = true;
            
            fetch('/system-settings-wifi', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ssid: document.getElementById('wifi-ssid').value,
                    password: document.getElementById('wifi-pass').value
                })
            }).then(r => r.json()).then(data => {
                resultDiv.textContent = data.success ? 'WiFi settings saved!' : (data.error || 'Error saving settings');
                resultDiv.className = data.success ? 'status-message status-success' : 'status-message status-error';
                resultDiv.style.display = 'block';
                
                if (data.success) {
                    setTimeout(loadWifiStatus, 2000);
                }
            }).catch(error => {
                resultDiv.textContent = 'Error updating WiFi settings: ' + error.message;
                resultDiv.className = 'status-message status-error';
                resultDiv.style.display = 'block';
            }).finally(() => {
                submitBtn.disabled = false;
            });
        };
        
        // Hotspot form submit (just saves settings, doesn't activate)
        document.getElementById('hotspot-form').onsubmit = function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('hotspot-result');
            
            if (document.getElementById('hotspot-pass').value.length < 8) {
                resultDiv.textContent = 'Password must be at least 8 characters';
                resultDiv.className = 'status-message status-error';
                resultDiv.style.display = 'block';
                return;
            }
            
            resultDiv.textContent = 'Hotspot settings saved! Use "Switch to Hotspot Mode" to activate.';
            resultDiv.className = 'status-message status-success';
            resultDiv.style.display = 'block';
        };
          // Reboot button
        document.getElementById('reboot-btn').onclick = function() {
            if (!confirm('Are you sure you want to reboot the system?')) return;
            const resultDiv = document.getElementById('reboot-result');
            const rebootBtn = document.getElementById('reboot-btn');
            
            // Show updating message
            resultDiv.textContent = 'Initiating system reboot...';
            resultDiv.className = 'status-message';
            resultDiv.style.display = 'block';
            rebootBtn.disabled = true;
            
            fetch('/system-settings-reboot', { method: 'POST' })
                .then(r => r.json())
                .then(function(data) {                    if (data.success) {
                        resultDiv.textContent = 'System rebooting...';
                        resultDiv.className = 'status-message status-success';
                        // Show overlay and start polling
                        document.getElementById('overlay').style.display = 'flex';
                        setTimeout(function pollForReload() {
                            fetch(window.location.href, {cache: 'no-store'})
                                .then(r => {
                                    if (r.ok) {
                                        window.location.reload();
                                    } else {
                                        setTimeout(pollForReload, 2000);
                                    }
                                })
                                .catch(() => setTimeout(pollForReload, 2000));
                        }, 5000); // Wait 5s before first poll
                    } else {
                        resultDiv.textContent = data.error || 'Reboot failed';
                        resultDiv.className = 'status-message status-error';
                        resultDiv.style.display = 'block';
                        rebootBtn.disabled = false;
                    }
                }).catch(error => {
                    resultDiv.textContent = 'Error initiating reboot: ' + error.message;
                    resultDiv.className = 'status-message status-error';
                    resultDiv.style.display = 'block';
                    rebootBtn.disabled = false;
                });
        };
        
        // Check for Updates button
        var checkUpdateBtn = document.getElementById('check-update-btn');
        var updateStatus = document.getElementById('update-status');
        var updateDetails = document.getElementById('update-details');
        var doUpdateBtn = document.getElementById('do-update-btn');
        
        if (checkUpdateBtn) {
            checkUpdateBtn.onclick = function() {
                updateStatus.textContent = 'Checking for updates...';
                updateStatus.className = 'status-message';
                updateStatus.style.display = 'block';
                updateDetails.innerHTML = '';
                
                fetch('/system-check-update', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            updateStatus.textContent = data.summary;
                            updateStatus.className = 'status-message status-success';
                            
                            if (data.updates === true) {
                                doUpdateBtn.style.display = 'inline-block';
                                // Show update details if present
                                if (data.details && data.details.length > 0) {
                                    updateDetails.innerHTML = '<pre style="white-space:pre-wrap;word-break:break-all; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">' + data.details + '</pre>';
                                }
                            } else {
                                updateDetails.innerHTML = '';
                                doUpdateBtn.style.display = 'none';
                            }
                        } else {
                            updateStatus.textContent = data.error || 'Update check failed.';
                            updateStatus.className = 'status-message status-error';
                            updateDetails.innerHTML = '';
                            doUpdateBtn.style.display = 'none';
                        }
                    })
                    .catch(e => {
                        updateStatus.textContent = 'Update check failed.';
                        updateStatus.className = 'status-message status-error';
                        updateDetails.innerHTML = '';
                        doUpdateBtn.style.display = 'none';
                    });
            };
        }
        
        if (doUpdateBtn) {
            doUpdateBtn.onclick = function() {
                doUpdateBtn.disabled = true;
                updateStatus.textContent = 'Updating...';
                updateStatus.className = 'status-message';
                updateDetails.innerHTML = '';
                
                fetch('/system-do-update', { method: 'POST' })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        let statusSet = false;
                        if (data.success) {
                            updateStatus.textContent = 'Update complete!';
                            updateStatus.className = 'status-message status-success';
                            statusSet = true;
                            // After successful update, call /system-restart-services (fire and forget)
                            fetch('/system-restart-services', { method: 'POST' });
                        } else if (data.results && data.results.length > 0) {
                            let found = data.results.find(x => /update (complete|successful|succeeded)/i.test(x));
                            if (found) {
                                updateStatus.textContent = found;
                                updateStatus.className = 'status-message status-success';
                                statusSet = true;
                            }
                        }
                        if (!statusSet) {
                            updateStatus.textContent = data.error || 'Update failed.';
                            updateStatus.className = 'status-message status-error';
                        }
                        
                        if (data.results && data.results.length > 0) {
                            let html = '<div style="margin-top:1rem;"><strong>Update Results:</strong><ul style="text-align: left; margin-top: 0.5rem;">';
                            data.results.forEach(function(res) {
                                html += `<li>${res}</li>`;
                            });
                            html += '</ul></div>';
                            updateDetails.innerHTML = html;
                        }
                        
                        if (data.traceback) {
                            updateDetails.innerHTML += `<pre style="color: var(--accent-color); white-space: pre-wrap; word-break: break-all; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;"><strong>Traceback:</strong>\n${data.traceback}</pre>`;
                        }
                        
                        doUpdateBtn.disabled = false;
                    })
                    .catch(function(e) {
                        let msg = (e && e.message) ? e.message : (typeof e === 'string' ? e : (e && e.toString ? e.toString() : 'Network or server error.'));
                        updateStatus.textContent = 'Update failed: ' + msg;
                        updateStatus.className = 'status-message status-error';
                        updateDetails.innerHTML = '<pre style="color: var(--accent-color); white-space: pre-wrap; word-break: break-all; background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">' + msg + '</pre>';
                        doUpdateBtn.disabled = false;
                    });
            };
        }
        
        // Auth password visibility toggle
        document.getElementById('toggle-auth-pass').onchange = function() {
            document.getElementById('auth-password').type = this.checked ? 'text' : 'password';
        };
    });
    </script>
</body>
</html>
